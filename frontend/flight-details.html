<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Details</title>
    <!-- favicon -->
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <!-- Google Fonts: Inter -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Inter", "Segoe UI", sans-serif;
        }

        body {
            background: #f8fafc;
            min-height: 100vh;
            color: #1e293b;
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            padding: 30px 20px;
            position: relative;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: #ffffff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #2563eb;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .logo-text h1 {
            font-size: 26px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }

        .logo-text p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
        }

        .back-button {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            max-width: 1400px;
            margin: -20px auto 40px;
            padding: 0 20px;
            position: relative;
            z-index: 2;
        }

        .flight-info-card {
            background: #ffffff;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 25px;
        }

        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
            flex-wrap: wrap;
            gap: 15px;
        }

        .airline-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .airline-logo-big {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: #2563eb;
        }

        .airline-details h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .airline-details p {
            font-size: 14px;
            color: #64748b;
        }

        .price-section {
            text-align: right;
        }

        .price-big {
            font-size: 36px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 5px;
        }

        .price-label {
            font-size: 13px;
            color: #64748b;
        }

        .route-timeline {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            align-items: center;
            margin-bottom: 30px;
        }

        .timeline-point {
            text-align: center;
        }

        .timeline-point.departure {
            text-align: left;
        }

        .timeline-point.arrival {
            text-align: right;
        }

        .city-name {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .time-big {
            font-size: 32px;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 5px;
        }

        .date-info {
            font-size: 14px;
            color: #64748b;
        }

        .timeline-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .flight-line {
            width: 200px;
            height: 3px;
            background: linear-gradient(90deg, #2563eb 0%, #7c3aed 100%);
            position: relative;
        }

        .flight-line::after {
            content: '✈';
            position: absolute;
            right: -10px;
            top: -10px;
            font-size: 18px;
            color: #2563eb;
        }

        .duration-big {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .stops-badge {
            display: inline-block;
            padding: 6px 14px;
            background: #dcfce7;
            color: #16a34a;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 600;
        }

        .map-section {
            background: #ffffff;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #map {
            height: 450px;
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .detail-card {
            background: #ffffff;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }

        .detail-card h3 {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 14px;
            color: #64748b;
        }

        .detail-value {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .action-section {
            background: #ffffff;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .action-info h3 {
            font-size: 22px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .action-info p {
            font-size: 14px;
            color: #64748b;
        }

        .book-now-btn {
            padding: 16px 40px;
            background: #16a34a;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
        }

        .book-now-btn:hover {
            background: #15803d;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(22, 163, 74, 0.4);
        }

        .animated-path {
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -20;
            }
        }

        /* Multi-Segment Timeline Styles */
        .segment-timeline-section {
            background: #ffffff;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 25px;
        }

        .segment-timeline-container {
            position: relative;
            padding: 20px 0;
        }

        .segment-card {
            position: relative;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            border-left: 4px solid #2563eb;
            transition: all 0.3s;
        }

        .segment-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
        }

        .segment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .segment-flight-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .segment-airline-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
        }

        .segment-airline-details h4 {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .segment-airline-details p {
            font-size: 13px;
            color: #64748b;
        }

        .segment-duration {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(37, 99, 235, 0.1);
            border-radius: 10px;
            color: #2563eb;
            font-weight: 600;
            font-size: 14px;
        }

        .segment-route {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .segment-airport {
            text-align: center;
        }

        .segment-airport.departure {
            text-align: left;
        }

        .segment-airport.arrival {
            text-align: right;
        }

        .segment-airport-code {
            font-size: 24px;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 5px;
        }

        .segment-airport-time {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .segment-airport-city {
            font-size: 13px;
            color: #64748b;
        }

        .segment-flight-path {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 150px;
        }

        .segment-flight-line {
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #2563eb 0%, #7c3aed 100%);
            position: relative;
        }

        .segment-flight-line::after {
            content: '✈';
            position: absolute;
            right: -10px;
            top: -10px;
            font-size: 16px;
            color: #2563eb;
            animation: fly 2s ease-in-out infinite;
        }

        @keyframes fly {

            0%,
            100% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(-10px);
            }
        }

        .segment-flight-duration {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
        }

        .segment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px;
            background: rgba(37, 99, 235, 0.05);
            border-radius: 10px;
        }

        .segment-detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .segment-detail-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .segment-detail-value {
            font-size: 15px;
            font-weight: 600;
            color: #1e293b;
        }

        /* Layover Indicator */
        .layover-indicator {
            position: relative;
            padding: 20px;
            margin: -15px 0 15px 0;
            text-align: center;
        }

        .layover-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #2563eb 0%, #94a3b8 50%, #2563eb 100%);
            transform: translateX(-50%);
        }

        .layover-badge {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .layover-badge i {
            color: #f59e0b;
            font-size: 16px;
        }

        .layover-time {
            color: #f59e0b;
        }

        .layover-warning {
            background: #fef3c7;
            border-color: #fbbf24;
        }

        .layover-warning .layover-time {
            color: #b45309;
        }

        @media(max-width: 900px) {
            .route-timeline {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .timeline-point.departure,
            .timeline-point.arrival {
                text-align: center;
            }

            .timeline-center {
                margin: 30px 0;
            }

            .flight-line {
                width: 3px;
                height: 100px;
                background: linear-gradient(180deg, #2563eb 0%, #7c3aed 100%);
            }

            .flight-line::after {
                transform: rotate(90deg);
                right: auto;
                left: -7px;
                top: auto;
                bottom: -11px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .flight-header {
                flex-direction: column;
                text-align: center;
            }

            .price-section {
                text-align: center;
            }

            /* Segment Timeline Mobile Styles */
            .segment-route {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .segment-airport.departure,
            .segment-airport.arrival {
                text-align: center;
            }

            .segment-flight-path {
                order: 2;
            }

            .segment-flight-line {
                width: 3px;
                height: 60px;
                background: linear-gradient(180deg, #2563eb 0%, #7c3aed 100%);
            }

            .segment-flight-line::after {
                transform: rotate(90deg);
                right: auto;
                left: -7px;
                top: auto;
                bottom: -8px;
            }

            .segment-details {
                grid-template-columns: 1fr;
            }

            .segment-header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon"><i class="fas fa-plane-departure"></i></div>
                <div class="logo-text">
                    <h1>SkyBooker</h1>
                    <p>Flight Details</p>
                </div>
            </div>
            <button class="back-button" onclick="window.location.href='index.html'">
                <i class="fas fa-arrow-left"></i> Back to Search
            </button>
        </div>
    </div>

    <div class="main-content">
        <!-- Flight Info Card -->
        <div class="flight-info-card">
            <div class="flight-header">
                <div class="airline-section">
                    <div class="airline-logo-big"><i class="fas fa-plane"></i></div>
                    <div class="airline-details">
                        <h2 id="dAirline">Loading...</h2>
                        <p id="dFlightId">...</p>
                    </div>
                </div>
                <div class="price-section">
                    <div class="price-big" id="dPrice">₹0</div>
                    <div class="price-label">per person</div>
                </div>
            </div>

            <div class="route-timeline">
                <div class="timeline-point departure">
                    <div class="city-name" id="dFromCity">...</div>
                    <div class="time-big" id="dDepTime">...</div>
                    <div class="date-info" id="dDate">...</div>
                </div>

                <div class="timeline-center">
                    <div class="duration-big" id="dDuration">...</div>
                    <div class="flight-line"></div>
                    <div class="stops-badge" id="dStops">Non-Stop</div>
                </div>

                <div class="timeline-point arrival">
                    <div class="city-name" id="dToCity">...</div>
                    <div class="time-big" id="dArrTime">...</div>
                    <div class="date-info" id="dDateArr">...</div>
                </div>
            </div>
        </div>

        <!-- Multi-Segment Timeline (for connecting flights) -->
        <div id="segmentTimeline" class="segment-timeline-section" style="display: none;">
            <div class="section-title">
                <i class="fas fa-route"></i> Flight Journey Details
            </div>
            <div id="segmentTimelineContainer"></div>
        </div>

        <!-- Map Section -->
        <div class="map-section">
            <div class="section-title">
                <i class="fas fa-map"></i> Flight Route
            </div>
            <div id="map"></div>
        </div>

        <!-- Details Grid -->
        <div class="details-grid">
            <div class="detail-card">
                <h3><i class="fas fa-info-circle"></i> Flight Information</h3>
                <div class="detail-item"><span class="detail-label">Route</span><span class="detail-value"
                        id="dRouteInfo">...</span></div>
                <div class="detail-item"><span class="detail-label">Class</span><span
                        class="detail-value">Economy</span></div>
                <div class="detail-item"><span class="detail-label">Stops</span><span class="detail-value"
                        id="dStopsDetail">...</span></div>
            </div>
            <div class="detail-card">
                <h3><i class="fas fa-suitcase"></i> Baggage Allowance</h3>
                <div class="detail-item"><span class="detail-label">Cabin Bag</span><span class="detail-value">7 kg (1
                        piece)</span></div>
                <div class="detail-item"><span class="detail-label">Check-in Bag</span><span class="detail-value">15 kg
                        (1 piece)</span></div>
            </div>
            <div class="detail-card">
                <h3><i class="fas fa-ticket-alt"></i> Fare Breakdown</h3>
                <div class="detail-item"><span class="detail-label">Base Fare</span><span class="detail-value"
                        id="dBaseFare">...</span></div>
                <div class="detail-item"><span class="detail-label">Taxes & Fees</span><span
                        class="detail-value">₹850</span></div>
                <div class="detail-item"><span class="detail-label">Total</span><span class="detail-value"
                        id="dTotalPrice">...</span></div>
            </div>
        </div>

        <div class="action-section">
            <div class="action-info">
                <h3>Ready to Book?</h3>
                <p>Secure your seat now. Limited availability at this price.</p>
            </div>
            <button class="book-now-btn" onclick="alert('Proceeding to Payment Gateway...')">
                <i class="fas fa-check-circle"></i> Pay & Book
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // const BASE_URL = "https://daa-project-1-7w2x.onrender.com";
        // const BASE_URL= "http://localhost:18080"
        const BASE_URL = "https://daa-project-api-services.onrender.com";

        // 1. Retrieve Data from LocalStorage
        const rawData = localStorage.getItem('selectedFlight');
        if (!rawData) {
            alert("No flight selected. Returning to search.");
            window.location.href = 'index.html';
        }
        const flight = JSON.parse(rawData);

        // 2. Initialize UI
        function populateUI() {
            const firstSegment = flight.segments[0];
            const lastSegment = flight.segments[flight.segments.length - 1];

            // Header Info
            document.getElementById('dAirline').textContent = firstSegment.airline;
            document.getElementById('dFlightId').textContent = `Flight ID: ${firstSegment.flight_id}`;
            document.getElementById('dPrice').textContent = `₹${flight.total_price}`;

            // Timeline
            document.getElementById('dFromCity').textContent = firstSegment.from;
            document.getElementById('dDepTime').textContent = firstSegment.dep;
            document.getElementById('dDate').textContent = firstSegment.date;

            document.getElementById('dToCity').textContent = lastSegment.to;
            document.getElementById('dArrTime').textContent = lastSegment.arr;
            document.getElementById('dDateArr').textContent = firstSegment.date;

            document.getElementById('dDuration').textContent = flight.duration_fmt;

            // Stops Logic
            const stopText = flight.stops === 0 ? "Non-Stop" : `${flight.stops} Stop(s)`;
            const badge = document.getElementById('dStops');
            badge.textContent = stopText;
            if (flight.stops > 0) {
                badge.style.background = "#fff7ed";
                badge.style.color = "#c2410c";
            }

            // Details Grid
            document.getElementById('dRouteInfo').textContent = `${firstSegment.from} ➝ ${lastSegment.to}`;
            document.getElementById('dStopsDetail').textContent = stopText;

            // Math for Fare
            const total = flight.total_price;
            const tax = 850;
            document.getElementById('dBaseFare').textContent = `₹${total - tax}`;
            document.getElementById('dTotalPrice').textContent = `₹${total}`;

            // Render Multi-Segment Timeline if connecting flights
            if (flight.segments.length > 1) {
                renderSegmentTimeline();
            }
        }

        // 3. Render Multi-Segment Timeline
        function renderSegmentTimeline() {
            const timelineSection = document.getElementById('segmentTimeline');
            const container = document.getElementById('segmentTimelineContainer');

            // Show the section
            timelineSection.style.display = 'block';

            let html = '';

            flight.segments.forEach((segment, index) => {
                // Calculate flight duration
                const depTime = segment.dep;
                const arrTime = segment.arr;

                // Segment Card
                html += `
                    <div class="segment-card">
                        <div class="segment-header">
                            <div class="segment-flight-info">
                                <div class="segment-airline-icon">
                                    <i class="fas fa-plane"></i>
                                </div>
                                <div class="segment-airline-details">
                                    <h4>${segment.airline}</h4>
                                    <p>Flight ${segment.flight_id}</p>
                                </div>
                            </div>
                            <div class="segment-duration">
                                <i class="fas fa-clock"></i>
                                <span>Segment ${index + 1} of ${flight.segments.length}</span>
                            </div>
                        </div>
                        
                        <div class="segment-route">
                            <div class="segment-airport departure">
                                <div class="segment-airport-code">${segment.from}</div>
                                <div class="segment-airport-time">${segment.dep}</div>
                                <div class="segment-airport-city">${getAirportCity(segment.from)}</div>
                            </div>
                            
                            <div class="segment-flight-path">
                                <div class="segment-flight-line"></div>
                                <div class="segment-flight-duration">${calculateSegmentDuration(segment.dep, segment.arr)}</div>
                            </div>
                            
                            <div class="segment-airport arrival">
                                <div class="segment-airport-code">${segment.to}</div>
                                <div class="segment-airport-time">${segment.arr}</div>
                                <div class="segment-airport-city">${getAirportCity(segment.to)}</div>
                            </div>
                        </div>
                        
                        <div class="segment-details">
                            <div class="segment-detail-item">
                                <span class="segment-detail-label">Departure</span>
                                <span class="segment-detail-value">${segment.dep} • ${segment.date}</span>
                            </div>
                            <div class="segment-detail-item">
                                <span class="segment-detail-label">Arrival</span>
                                <span class="segment-detail-value">${segment.arr} • ${segment.date}</span>
                            </div>
                            <div class="segment-detail-item">
                                <span class="segment-detail-label">Price</span>
                                <span class="segment-detail-value">₹${segment.price}</span>
                            </div>
                            <div class="segment-detail-item">
                                <span class="segment-detail-label">Class</span>
                                <span class="segment-detail-value">Economy</span>
                            </div>
                        </div>
                    </div>
                `;

                // Add layover indicator if not the last segment
                if (index < flight.segments.length - 1) {
                    const nextSegment = flight.segments[index + 1];
                    const layoverTime = calculateLayover(segment.arr, nextSegment.dep);
                    const isShortLayover = layoverTime < 60; // Less than 1 hour

                    html += `
                        <div class="layover-indicator">
                            <div class="layover-line"></div>
                            <div class="layover-badge ${isShortLayover ? 'layover-warning' : ''}">
                                <i class="fas fa-${isShortLayover ? 'exclamation-triangle' : 'clock'}"></i>
                                <span>Layover at ${segment.to}: <span class="layover-time">${formatLayoverTime(layoverTime)}</span></span>
                                ${isShortLayover ? '<span style="color: #b45309; font-size: 12px; margin-left: 5px;">(Tight connection!)</span>' : ''}
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        // Helper: Get airport city name (simplified - you can enhance with API call)
        function getAirportCity(code) {
            const cities = {
                'DEL': 'New Delhi', 'BOM': 'Mumbai', 'BLR': 'Bengaluru', 'MAA': 'Chennai',
                'CCU': 'Kolkata', 'HYD': 'Hyderabad', 'COK': 'Kochi', 'AMD': 'Ahmedabad',
                'PNQ': 'Pune', 'GOI': 'Goa', 'TRV': 'Thiruvananthapuram', 'CCJ': 'Kozhikode',
                'LKO': 'Lucknow', 'GAU': 'Guwahati', 'JAI': 'Jaipur', 'SXR': 'Srinagar',
                'BBI': 'Bhubaneswar', 'PAT': 'Patna', 'IXC': 'Chandigarh', 'IXB': 'Bagdogra'
            };
            return cities[code] || code;
        }

        // Helper: Calculate segment duration
        function calculateSegmentDuration(depTime, arrTime) {
            const [depH, depM] = depTime.split(':').map(Number);
            const [arrH, arrM] = arrTime.split(':').map(Number);

            let totalMinutes = (arrH * 60 + arrM) - (depH * 60 + depM);
            if (totalMinutes < 0) totalMinutes += 24 * 60; // Handle overnight flights

            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            return `${hours}h ${minutes}m`;
        }

        // Helper: Calculate layover time in minutes
        function calculateLayover(arrTime, nextDepTime) {
            const [arrH, arrM] = arrTime.split(':').map(Number);
            const [depH, depM] = nextDepTime.split(':').map(Number);

            let layoverMinutes = (depH * 60 + depM) - (arrH * 60 + arrM);
            if (layoverMinutes < 0) layoverMinutes += 24 * 60;

            return layoverMinutes;
        }

        // Helper: Format layover time
        function formatLayoverTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;

            if (hours === 0) return `${mins}m`;
            if (mins === 0) return `${hours}h`;
            return `${hours}h ${mins}m`;
        }

        // 3. Render Map with Animation
        // 3. Render Map with Animation
        async function renderMap() {
            // Prevent map re-initialization error if function runs twice
            if (L.DomUtil.get('map')._leaflet_id) {
                L.DomUtil.get('map')._leaflet_id = null;
            }

            var map = L.map('map');
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 18 }).addTo(map);

            const airportIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #2563eb; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">✈</div>',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            try {
                const res = await fetch(`${BASE_URL}/api/airports`);
                const allAirports = await res.json();

                // --- FIX 1: Sort segments by time to ensure A -> B -> C order ---
                // This prevents the line from being drawn "backwards" geographically
                const sortedSegments = [...flight.segments].sort((a, b) => {
                    return new Date(a.dep) - new Date(b.dep);
                });

                let pathCoords = [];

                sortedSegments.forEach(seg => {
                    const fromApt = allAirports.find(a => a.code === seg.from);
                    const toApt = allAirports.find(a => a.code === seg.to);

                    if (fromApt && toApt) {
                        // Handle different property names (long vs lng)
                        const fLat = fromApt.lat, fLng = fromApt.long || fromApt.lng;
                        const tLat = toApt.lat, tLng = toApt.long || toApt.lng;

                        pathCoords.push([fLat, fLng]);
                        pathCoords.push([tLat, tLng]);

                        L.marker([fLat, fLng], { icon: airportIcon }).addTo(map).bindPopup(seg.from);
                        L.marker([tLat, tLng], { icon: airportIcon }).addTo(map).bindPopup(seg.to);
                    }
                });

                if (pathCoords.length > 0) {
                    // Static Base Line
                    const polyline = L.polyline(pathCoords, {
                        color: "#2563eb",
                        weight: 4,
                        opacity: 0.3,
                        dashArray: '10, 10'
                    }).addTo(map);

                    // --- FIX 2: Removed 'className: animated-path' ---
                    // We rely PURELY on the setInterval below for smoother control
                    const animatedLine = L.polyline(pathCoords, {
                        color: "#7c3aed",
                        weight: 4,
                        opacity: 0.8,
                        dashArray: '10, 10',
                        dashOffset: '0'
                    }).addTo(map);

                    let offset = 0;
                    setInterval(() => {
                        // Decrement for Source -> Destination flow
                        offset -= 1;
                        animatedLine.setStyle({ dashOffset: offset.toString() });
                    }, 50);

                    map.fitBounds(pathCoords, { padding: [50, 50] });
                } else {
                    map.setView([20.5, 78.9], 5);
                }

            } catch (e) {
                console.error("Map Error:", e);
                map.setView([20.5, 78.9], 5);
            }
        }
        // Run
        populateUI();
        renderMap();
    </script>
</body>

</html>